<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Excel Search</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    input[type="text"] { padding: 5px; width: 300px; }
    button { padding: 5px 10px; margin-left: 10px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    mark { background-color: yellow; }
  </style>
</head>
<body>
  <h1>Excel Search Tool</h1>

  <p>Upload Excel files (or leave blank if you load from repo)</p>
  <input type="file" id="file1" /> 
  <input type="file" id="file2" /> 
  <input type="file" id="file3" /><br><br>

  <input type="text" id="search" placeholder="Enter keywords, separated by space" />
  <button onclick="searchData()">Search</button>

  <div id="results"></div>

  <script>
    let datasets = []; // store parsed Excel files

    // Load uploaded files
    function handleFile(fileInput, index) {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
        datasets[index] = { name: file.name, data: jsonData };
        renderTable(index, jsonData, []); // show full table initially
      };
      reader.readAsArrayBuffer(file);
    }

    document.getElementById("file1").addEventListener("change", e => handleFile(e.target, 0));
    document.getElementById("file2").addEventListener("change", e => handleFile(e.target, 1));
    document.getElementById("file3").addEventListener("change", e => handleFile(e.target, 2));

    function searchData() {
      const input = document.getElementById("search").value.toLowerCase().trim();
      const keywords = input.split(/\s+/).filter(k => k); // split by spaces
      document.getElementById("results").innerHTML = ""; // clear old results

      datasets.forEach((ds, i) => {
        if (!ds || !ds.data) return;
        let matches = ds.data.filter(row => {
         // Convert all cell values to strings, lowercase
            const rowText = Object.values(row)
           .map(v => (v === null || v === undefined) ? "" : String(v).toLowerCase())
           .join(" ");
         // Match ALL keywords
        return keywords.every(kw => rowText.includes(kw));
       });
       renderTable(i, matches, keywords);
     });
   }


    function renderTable(index, rows, keywords) {
      const container = document.getElementById("results");
      const ds = datasets[index];
      if (!rows || rows.length === 0) {
        container.innerHTML += `<h2>${ds.name}</h2><p>No matches found.</p>`;
        return;
      }

      let html = `<h2>${ds.name}</h2><table><tr>`;
      Object.keys(rows[0]).forEach(k => html += `<th>${k}</th>`);
      html += "</tr>";

      rows.forEach(row => {
        html += "<tr>";
        Object.values(row).forEach(v => {
          let cell = String(v);
          keywords.forEach(kw => {
            let regex = new RegExp(`(${kw})`, "gi");
            cell = cell.replace(regex, "<mark>$1</mark>");
          });
          html += `<td>${cell}</td>`;
        });
        html += "</tr>";
      });
      html += "</table>";
      container.innerHTML += html;
    }
  </script>
</body>
</html>
